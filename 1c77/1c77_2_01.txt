//Получаем таблицу обеспечения вещами для военнослужащего
//	ВоинскаяЧасть - ссылка на справочник фирм
//	СпрАКСсылка - ссылка на справочник арматурных карточек
//	А70 - этот счет обязателен для работы (субконто - сотрудники и номенклатура)
Функция РасчитатьОбеспеченностьВоеннослужащего(ВоинскаяЧасть, СпрАКСсылка, НоваяРабДата="") Экспорт
	
	//установка параметров
	Норма=СпрАКСсылка.Норма;
	Сотрудник=СпрАКСсылка.Сотрудник;
	ДатаНачалаСлужбы=СпрАКСсылка.ДатаНачалаСлужбы;
	ДатаПостановкиНаУчет=СпрАКСсылка.ДатаПостановкиНаУчет;
	ДатаСнятияСУчетаПоПриказу=СпрАКСсылка.ДатаСнятияСУчетаПоПриказу;
	
	//расчет рабочей даты (актуальной)
	Если НоваяРабДата<>"" Тогда
		РабДата=НоваяРабДата;
	Иначе
		РабДата=ТекущаяДата();
	КонецЕсли;
	Если СпрАКСсылка.СтоитНаУчете=0 Тогда
		Если ПустоеЗначение(ДатаСнятияСУчетаПоПриказу)=0 Тогда
			РабДата=ДатаСнятияСУчетаПоПриказу;
		КонецЕсли;
	КонецЕсли;
	РабДата=КонМесяца(РабДата);	
	
	//показываем только 5 лет
	Год1="";
	Год2="";
	Год3="";
	Год4="";
	Год5="";
	Если (ДатаГод(РабДата)-ДатаГод(ДатаПостановкиНаУчет))<6 Тогда
		//вариант когда расчет от - даты постановки на учет
		НачГод=ДатаГод(ДатаПостановкиНаУчет);
		Год1=СокрЛП(НачГод);
		Для ИИ=2 По 5 Цикл
			Если ИИ=2 Тогда
				Год2=СокрЛП(НачГод+ИИ-1);
			ИначеЕсли ИИ=3 Тогда
				Год3=СокрЛП(НачГод+ИИ-1);
			ИначеЕсли ИИ=4 Тогда
				Год4=СокрЛП(НачГод+ИИ-1);
			ИначеЕсли ИИ=5 Тогда
				Год5=СокрЛП(НачГод+ИИ-1);
			КонецЕсли;
		КонецЦикла;
	Иначе
		//вариант когда расчет от - рабочей даты
		НачГод=ДатаГод(РабДата);
		Год5=СокрЛП(НачГод);
		Для ИИ=1 По 4 Цикл
			Если ИИ=1 Тогда
				Год4=СокрЛП(НачГод-ИИ);
			ИначеЕсли ИИ=2 Тогда
				Год3=СокрЛП(НачГод-ИИ);
			ИначеЕсли ИИ=3 Тогда
				Год2=СокрЛП(НачГод-ИИ);
			ИначеЕсли ИИ=4 Тогда
				Год1=СокрЛП(НачГод-ИИ);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ТабРасчет=СоздатьОбъект("ТаблицаЗначений");
	ТабРасчет.НоваяКолонка("Номенклатура","Справочник.Номенклатура",,,"Наименование предметов",40);
	ТабРасчет.НоваяКолонка("НаНачалоДата","Дата",,,"НаНач.-мес",15);
	ТабРасчет.НоваяКолонка("НаНачало","Число",3,0,"НаНач.-кол",15);
	ТабРасчет.НоваяКолонка("Год1дата","Строка",14,,Год1+"-мес",12);
	ТабРасчет.НоваяКолонка("Год1","Число",3,0,Год1+"-кол",12);
	ТабРасчет.НоваяКолонка("Год1Номер","Строка",14,,Год1+"-ном",12);
	ТабРасчет.НоваяКолонка("Год2дата","Строка",14,,Год2+"-мес",12);
	ТабРасчет.НоваяКолонка("Год2","Число",3,0,Год2+"-кол",12);
	ТабРасчет.НоваяКолонка("Год2Номер","Строка",14,,Год2+"-ном",12);
	ТабРасчет.НоваяКолонка("Год3дата","Строка",14,,Год3+"-мес",12);
	ТабРасчет.НоваяКолонка("Год3","Число",3,0,Год3+"-кол",12);
	ТабРасчет.НоваяКолонка("Год3Номер","Строка",14,,Год3+"-ном",12);
	ТабРасчет.НоваяКолонка("Год4дата","Строка",14,,Год4+"-мес",12);
	ТабРасчет.НоваяКолонка("Год4","Число",3,0,Год4+"-кол",12);
	ТабРасчет.НоваяКолонка("Год4Номер","Строка",14,,Год4+"-ном",12);
	ТабРасчет.НоваяКолонка("Год5дата","Строка",14,,Год5+"-мес",12);
	ТабРасчет.НоваяКолонка("Год5","Число",3,0,Год5+"-кол",12);
	ТабРасчет.НоваяКолонка("Год5Номер","Строка",14,,Год5+"-ном",12);
	ТабРасчет.НоваяКолонка("КВыдаче","Число",3,0,"Остаток",15);
	ТабРасчет.НоваяКолонка("Колво","Число",3,0);
	ТабРасчет.НоваяКолонка("СрокМес","Число",3,0);
		
	//загрузка норм
	Норма.ВыбратьСтроки();
	Пока Норма.ПолучитьСтроку() = 1 Цикл
		ТабРасчет.НоваяСтрока();
		ТабРасчет.Номенклатура = Норма.Номенклатура;
		ТабРасчет.Колво = Норма.Колво;
		ТабРасчет.СрокМес = Норма.СрокМес;
	КонецЦикла;
	
	//загрузка данных на начало учета (без учета даты начала выдачи)
	ДокВыбран=0;
	ДокПостановки=СоздатьОбъект("Документ.ПостановкаНаУчетВО");
	ДокПостановки.ВыбратьДокументы();
	Пока ДокПостановки.ПолучитьДокумент() = 1 Цикл
		Если ДокПостановки.Сотрудник=Сотрудник Тогда
			ДокВыбран=1;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если ДокВыбран=1 Тогда
		ДокПостановки.ВыбратьСтроки();
		Пока ДокПостановки.ПолучитьСтроку() = 1 Цикл
			ТабРасчет.НоваяСтрока();
			ТабРасчет.Номенклатура = ДокПостановки.Номенклатура;
			ТабРасчет.НаНачало = ДокПостановки.Колво;
		КонецЦикла;
	КонецЕсли;
	
	ТабРасчет.Свернуть("Номенклатура,НаНачалоДата,Год1дата,Год1Номер,Год2дата,Год2Номер,Год3дата,Год3Номер,Год4дата,Год4Номер,Год5дата,Год5Номер", "НаНачало,Год1,Год2,Год3,Год4,Год5,КВыдаче,Колво,СрокМес");
	
	//расчитываем обороты по годам
	Для ИИ=1 По 5 Цикл
		Если ИИ=1 Тогда
			ГодИд=Число(Год1);
		ИначеЕсли ИИ=2 Тогда
			ГодИд=Число(Год2);
		ИначеЕсли ИИ=3 Тогда
			ГодИд=Число(Год3);
		ИначеЕсли ИИ=4 Тогда
			ГодИд=Число(Год4);
		ИначеЕсли ИИ=5 Тогда
			ГодИд=Число(Год5);
		КонецЕсли;
		НачПериод=Дата(ГодИд,1,1);
		Если НачПериод<ДатаПостановкиНаУчет Тогда
			НачПериод=ДатаПостановкиНаУчет+1;
		КонецЕсли;
		КонПериод=Дата(ГодИд,12,31);
		Если КонПериод>КонецРассчитанногоПериодаБИ() Тогда
			КонПериод=КонецРассчитанногоПериодаБИ();
		КонецЕсли;
		Если НачПериод>КонПериод Тогда
			Продолжить;
		КонецЕсли;
		
		Попытка
			Би = СоздатьОбъект("БухгалтерскиеИтоги");
			Би.ИспользоватьРазделительУчета(ВоинскаяЧасть); 
			Би.ИспользоватьСубконто(ВидыСубконто.Номенклатура);
			Би.ИспользоватьСубконто(ВидыСубконто.Сотрудники, Сотрудник, 2);
			Би.ВыполнитьЗапрос(НачПериод,КонПериод,"А70",,,1,,"К");
			Би.ВыбратьСубконто(ВидыСубконто.Номенклатура);
			Пока Би.ПолучитьСубконто(ВидыСубконто.Номенклатура) = 1 Цикл
				ТабРасчет.НоваяСтрока();
				ТабРасчет.Номенклатура = Би.Субконто(ВидыСубконто.Номенклатура);
				КолвоОборот=Би.ДО(3);
				Если ИИ=1 Тогда
					ТабРасчет.Год1 = КолвоОборот;
				ИначеЕсли ИИ=2 Тогда
					ТабРасчет.Год2 = КолвоОборот;
				ИначеЕсли ИИ=3 Тогда
					ТабРасчет.Год3 = КолвоОборот;
				ИначеЕсли ИИ=4 Тогда
					ТабРасчет.Год4 = КолвоОборот;
				ИначеЕсли ИИ=5 Тогда
					ТабРасчет.Год5 = КолвоОборот;
				КонецЕсли;	
			КонецЦикла;
		Исключение
		КонецПопытки;
	КонецЦикла;
	
	ТабРасчет.Свернуть("Номенклатура,НаНачалоДата,Год1дата,Год1Номер,Год2дата,Год2Номер,Год3дата,Год3Номер,Год4дата,Год4Номер,Год5дата,Год5Номер", "НаНачало,Год1,Год2,Год3,Год4,Год5,КВыдаче,Колво,СрокМес");
	
	//расчитываем остаток
	Би = СоздатьОбъект("БухгалтерскиеИтоги");
	Би.ИспользоватьРазделительУчета(ВоинскаяЧасть); 
	Би.ИспользоватьСубконто(ВидыСубконто.Номенклатура);
	Би.ИспользоватьСубконто(ВидыСубконто.Сотрудники, Сотрудник, 2);
	Би.ВыполнитьЗапрос(,РабДата,"А70",,,1,,"К");
	Би.ВыбратьСубконто(ВидыСубконто.Номенклатура);
	Пока Би.ПолучитьСубконто(ВидыСубконто.Номенклатура) = 1 Цикл
		ТабРасчет.НоваяСтрока();
		ТабРасчет.Номенклатура = Би.Субконто(ВидыСубконто.Номенклатура);
		ТабРасчет.КВыдаче = Би.СКД(3);
	КонецЦикла;
	
	ТабРасчет.Свернуть("Номенклатура,НаНачалоДата,Год1дата,Год1Номер,Год2дата,Год2Номер,Год3дата,Год3Номер,Год4дата,Год4Номер,Год5дата,Год5Номер", "НаНачало,Год1,Год2,Год3,Год4,Год5,КВыдаче,Колво,СрокМес");
	
	ТабРасчет.ВыбратьСтроки();
	Пока ТабРасчет.ПолучитьСтроку() = 1 Цикл
		Если ДокВыбран=1 Тогда
			ДокПостановки.ВыбратьСтроки();
			Пока ДокПостановки.ПолучитьСтроку() = 1 Цикл
				Если ТабРасчет.Номенклатура=ДокПостановки.Номенклатура Тогда
					ТабРасчет.НаНачалоДата = ДокПостановки.ДатаВыдачи;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;	
	
	//подрасчет - приостановка срока выдачи[
	ПриостановкаВыдачи=0;
	ДокПриостановка=СоздатьОбъект("Документ.ПриостановкаСрокаВыдачиВещей");
	ДокПриостановка.ВыбратьДокументы();
	Пока ДокПриостановка.ПолучитьДокумент() = 1 Цикл
		Если ДокПриостановка.Проведен()=0 Тогда
			Продолжить;
		КонецЕсли;
		Если ДокПриостановка.Военнослужащий<>Сотрудник Тогда
			Продолжить;
		КонецЕсли;
		ПриостановкаРасчет=Число(ДокПриостановка.ДатаПо)-Число(ДокПриостановка.ДатаС);
		ПриостановкаРасчет=?(ПриостановкаРасчет<=0,0,ПриостановкаРасчет/30);
		ПриостановкаВыдачи=ПриостановкаВыдачи+Окр(ПриостановкаРасчет,0);
	КонецЦикла;
	//] конец подрасчета
	
	ТабРасчет.ВыбратьСтроки();
	Пока ТабРасчет.ПолучитьСтроку() = 1 Цикл
		КолМесСлужбы=((ДатаГод(РабДата)-1)*12+ДатаМесяц(РабДата))-((ДатаГод(ТабРасчет.НаНачалоДата)-1)*12+ДатаМесяц(ТабРасчет.НаНачалоДата));
		КолМесСлужбы=КолМесСлужбы-ПриостановкаВыдачи;
		КолМесСлужбы=?(КолМесСлужбы<=0,0,КолМесСлужбы);
		КолВыдачи=Цел(КолМесСлужбы/ТабРасчет.СрокМес);
		ДолжноБытьВыдано=(КолВыдачи*ТабРасчет.Колво)+ТабРасчет.НаНачало;
		Разница=ДолжноБытьВыдано-ТабРасчет.КВыдаче;
		ТабРасчет.КВыдаче=?(Разница<=0,0,Разница);
	КонецЦикла;
	
	//добавляем периоды получения вещей
	ДокВыдача=СоздатьОбъект("Документ.ВыдачаВещейВоеннослужащим");
	ТабРасчет.ВыбратьСтроки();
	Пока ТабРасчет.ПолучитьСтроку() = 1 Цикл
		Для ИИ=1 По 5 Цикл
			Если ИИ=1 Тогда
				ГодИд=Число(Год1);
			ИначеЕсли ИИ=2 Тогда
				ГодИд=Число(Год2);
			ИначеЕсли ИИ=3 Тогда
				ГодИд=Число(Год3);
			ИначеЕсли ИИ=4 Тогда
				ГодИд=Число(Год4);
			ИначеЕсли ИИ=5 Тогда
				ГодИд=Число(Год5);
			КонецЕсли;
			НачПериод=Дата(ГодИд,1,1);
			Если НачПериод<ДатаПостановкиНаУчет Тогда
				НачПериод=ДатаПостановкиНаУчет+1;
			КонецЕсли;
			КонПериод=Дата(ГодИд,12,31);
			
			ДатыВыдачи="";
			НомераВыдачи="";
			ДокВыдача.ВыбратьДокументы(НачПериод,КонПериод);
			Пока ДокВыдача.ПолучитьДокумент() = 1 Цикл
				Если ДокВыдача.Проведен()=0 Тогда
					Продолжить;
				КонецЕсли;
				Если ДокВыдача.Сотрудник<>Сотрудник Тогда
					Продолжить;
				КонецЕсли;
				
				ДокВыдача.ВыбратьСтроки();
				Пока ДокВыдача.ПолучитьСтроку() = 1 Цикл
					Если (ДокВыдача.Номенклатура=ТабРасчет.Номенклатура) и (ДокВыдача.Выдано<>0) Тогда
						ДатыВыдачи=ДатыВыдачи+?(ДатыВыдачи="","",",")+Прав("0"+СокрЛП(ДатаМесяц(ДокВыдача.ДатаДок)),2);
						НомераВыдачи=НомераВыдачи+?(НомераВыдачи="","",",") + СокрЛП(ДокВыдача.НомерДок);
						Если ДокВыдача.Замена=Перечисление.Булево.Да Тогда
							ДатыВыдачи=ДатыВыдачи+"*";
							НомераВыдачи=НомераВыдачи+"*";
						КонецЕсли;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
			
			Если ИИ=1 Тогда
				ТабРасчет.Год1дата = ДатыВыдачи;
				ТабРасчет.Год1Номер = НомераВыдачи;
			ИначеЕсли ИИ=2 Тогда
				ТабРасчет.Год2дата = ДатыВыдачи;
				ТабРасчет.Год2Номер = НомераВыдачи;
			ИначеЕсли ИИ=3 Тогда
				ТабРасчет.Год3дата = ДатыВыдачи;
				ТабРасчет.Год3Номер = НомераВыдачи;
			ИначеЕсли ИИ=4 Тогда
				ТабРасчет.Год4дата = ДатыВыдачи;
				ТабРасчет.Год4Номер = НомераВыдачи;
			ИначеЕсли ИИ=5 Тогда
				ТабРасчет.Год5дата = ДатыВыдачи;
				ТабРасчет.Год5Номер = НомераВыдачи;
			КонецЕсли;	
		КонецЦикла;
	КонецЦикла;
	
	//расчитываем период последней выдачи в формате: ММ-ГГГГ
	ТабРасчет.НоваяКолонка("ДатаВыдачи","Строка",40);
	ТабРасчет.ВыбратьСтроки();
	Пока ТабРасчет.ПолучитьСтроку() = 1 Цикл
		ДатыВыдачиПосл="";
		Если ТабРасчет.Год5=0 Тогда
			Если ТабРасчет.Год4=0 Тогда
				Если ТабРасчет.Год3=0 Тогда
					Если ТабРасчет.Год2=0 Тогда
						Если ТабРасчет.Год1<>0 Тогда
							ДатыВыдачиПосл=СокрЛП(ТабРасчет.Год1дата)+"-"+СокрЛП(Год1);
						КонецЕсли;
					Иначе
						ДатыВыдачиПосл=СокрЛП(ТабРасчет.Год2дата)+"-"+СокрЛП(Год2);
					КонецЕсли;
				Иначе
					ДатыВыдачиПосл=СокрЛП(ТабРасчет.Год3дата)+"-"+СокрЛП(Год3);
				КонецЕсли;
			Иначе
				ДатыВыдачиПосл=СокрЛП(ТабРасчет.Год4дата)+"-"+СокрЛП(Год4);
			КонецЕсли;
		Иначе
			ДатыВыдачиПосл=СокрЛП(ТабРасчет.Год5дата)+"-"+СокрЛП(Год5);
		КонецЕсли;
		Если ДатыВыдачиПосл="" Тогда
			ДатыВыдачиПосл=СокрЛП(ДатаМесяц(ТабРасчет.НаНачалоДата))+"-"+СокрЛП(ДатаГод(ТабРасчет.НаНачалоДата));
		КонецЕсли;
		
		ТабРасчет.ДатаВыдачи=Прав(ДатыВыдачиПосл,7);
	КонецЦикла;
	
	//возвращаем таблицу
	ТабРасчет.Сортировать("Номенклатура +");
	Возврат ТабРасчет;
	
КонецФункции

//Получаем таблицу расхода в разрезе дней недели и З/О/У/Дополнительного
//	ТекДок - ссылка на документ раскладки продуктов
//	ДеньОбор - получение потребности только по одному дню
//	КолвоЧеловек - потребность расчитывается по указанному кол-ву человек
//	ИспользоватьСредние - расчитывает потреюность двух блюд по средней
Функция глПолучитьТаблРасход(ТекДок, ДеньОбор=0, КолвоЧеловекЗавтрак=0,  КолвоЧеловекОбед=0,  КолвоЧеловекУжин=0, ИспользоватьСредние=1) Экспорт
	
	//КолвоЧеловек=КолвоЧеловекЗавтрак;
	
	СпрСоставБлюда = СоздатьОбъект("Справочник.СоставБлюда");
	
	ТабРасход=СоздатьОбъект("ТаблицаЗначений");
	ТабРасход.НоваяКолонка("Продукт","Справочник.Номенклатура");
	ТабРасход.НоваяКолонка("Наименование");
	ТабРасход.НоваяКолонка("НомерПП","Число",5,0);
	ТабРасход.НоваяКолонка("НаЧел","Число",10,1);
	ТабРасход.НоваяКолонка("Всего","Число",15,3);
	ТабРасход.НоваяКолонка("Остаток","Число",15,3);
	ТабРасход.НоваяКолонка("Нехватает","Число",15,3);
	ТабРасход.НоваяКолонка("День","Число",1,0);
	ТабРасход.НоваяКолонка("ЗОУ","Число",1,0);
	
	//Считываем имена формы для перебора
	ТабИмена=СоздатьОбъект("ТаблицаЗначений");
	ТабИмена.НоваяКолонка("ИмяЭлемента");
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "З_2блюдо_основа1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "З_2блюдо_гарнир1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "З_дополнительно_ч1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "З_дополнительно_ч2";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_Закуска";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_1блюдо1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_2блюдо_основа1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_2блюдо_гарнир1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_дополнительно_ч1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "О_дополнительно_ч2";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "У_2блюдо_основа1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "У_2блюдо_гарнир1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "У_дополнительно_ч1";
	ТабИмена.НоваяСтрока();
	ТабИмена.ИмяЭлемента = "У_дополнительно_ч2";
	КолИмен=ТабИмена.КоличествоСтрок();
	
	//Обходим элементы
	ДеньНач=1;
	ДеньКон=7;
	Если ДеньОбор>0 Тогда
		ДеньНач=ДеньОбор;
		ДеньКон=ДеньОбор;
	КонецЕсли;
	
	Для ДеньНедели=ДеньНач По ДеньКон Цикл
		Приставка="П";
		Если ДеньНедели=2 Тогда
			Приставка="В";
		ИначеЕсли ДеньНедели=3 Тогда
			Приставка="С";
		ИначеЕсли ДеньНедели=4 Тогда
			Приставка="Ч";
		ИначеЕсли ДеньНедели=5 Тогда
			Приставка="Пт";
		ИначеЕсли ДеньНедели=6 Тогда
			Приставка="Сб";
		ИначеЕсли ДеньНедели=7 Тогда
			Приставка="Вс";
		КонецЕсли;
		
		Для НомИмени=1 По КолИмен Цикл
			ТабИмена.ПолучитьСтрокуПоНомеру(НомИмени);;
			ПриставкаЗОУ=Лев(СокрЛП(ТабИмена.ИмяЭлемента),1);
			ИмяЭлемента=Приставка+ТабИмена.ИмяЭлемента;
			Элемент=ТекДок.ПолучитьАтрибут(ИмяЭлемента);
			
			//определение коэфициента
			ИмяЭлемента=ТабИмена.ИмяЭлемента;
			Коэфициент=1;
			Если ИспользоватьСредние=0 Тогда
				Коэфициент=1;
			КонецЕсли;
			
			Если ПустоеЗначение(Элемент)=0 Тогда
				//Считываем состав блюд
				СпрСоставБлюда.ИспользоватьВладельца(Элемент);
				СпрСоставБлюда.ВыбратьЭлементы();
				Пока СпрСоставБлюда.ПолучитьЭлемент() = 1 Цикл
					ТабРасход.НоваяСтрока();
					ТабРасход.Продукт = СпрСоставБлюда.Продукт;
					ТабРасход.Наименование = СпрСоставБлюда.Продукт.Наименование+", "+СокрЛП(СпрСоставБлюда.Продукт.ЕдИзм.Наименование);
					ТабРасход.НомерПП = СпрСоставБлюда.Продукт.НомерПП;
					ТабРасход.НаЧел = (СпрСоставБлюда.НормаГ)*Коэфициент;
					ЕдИзм=СокрЛП(СпрСоставБлюда.Продукт.ЕдИзм.Код);
					Если (ЕдИзм="166") или (ЕдИзм="961") Тогда
						//не считаем банки штучно, а так же по весу как и кг
						Всего = (СпрСоставБлюда.НормаГ/1000)*Коэфициент;
					Иначе
						Всего = (СпрСоставБлюда.НормаГ)*Коэфициент;
					КонецЕсли;
					Если ПриставкаЗОУ="З" Тогда
						Всего=Всего*КолвоЧеловекЗавтрак;
					ИначеЕсли ПриставкаЗОУ="О" Тогда
						Всего=Всего*КолвоЧеловекОбед;
					Иначе
						Всего=Всего*КолвоЧеловекУжин;	
					КонецЕсли;
					ТабРасход.Всего = Всего;
					ТабРасход.Остаток = 0;
					ТабРасход.Нехватает = 0;					
					ТабРасход.День = ДеньНедели;
					Если ПриставкаЗОУ="З" Тогда
						ТабРасход.ЗОУ = 1;
					ИначеЕсли ПриставкаЗОУ="О" Тогда
						ТабРасход.ЗОУ = 2;
					Иначе
						ТабРасход.ЗОУ = 3;	
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	//Загружаем дополнительный расход (если он указан)
	ДопДневнойРасход=ТекДок.ДопДневнойРасход;
	Если ПустоеЗначение(ДопДневнойРасход)=0 Тогда
		Для ДеньНедели=ДеньНач По ДеньКон Цикл
			ДопДневнойРасход.ВыбратьСтроки();
			Пока ДопДневнойРасход.ПолучитьСтроку() = 1 Цикл
				ТабРасход.НоваяСтрока();
				ТабРасход.Продукт = ДопДневнойРасход.Продукт;
				ТабРасход.Наименование = ДопДневнойРасход.Продукт.Наименование+", "+СокрЛП(ДопДневнойРасход.Продукт.ЕдИзм.Наименование);
				ТабРасход.НомерПП = ДопДневнойРасход.Продукт.НомерПП;
				ТабРасход.НаЧел = ДопДневнойРасход.РасходНаЧел;
				ЕдИзм=СокрЛП(ДопДневнойРасход.Продукт.ЕдИзм.Код);
				СрКолвоЧеловек=(КолвоЧеловекЗавтрак+КолвоЧеловекОбед+КолвоЧеловекУжин)/3;
				Если (ЕдИзм="166") или (ЕдИзм="961") Тогда
					//не считаем банки штучно, а так же по весу как и кг
					Всего = ДопДневнойРасход.РасходНаЧел*СрКолвоЧеловек/1000;
				Иначе
					Всего = ДопДневнойРасход.РасходНаЧел*СрКолвоЧеловек;
				КонецЕсли;
				ТабРасход.Всего = Всего;
				ТабРасход.Остаток = 0;
				ТабРасход.Нехватает = 0;					
				ТабРасход.День = ДеньНедели;
				ТабРасход.ЗОУ = 9;	
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;
	
	//возвращаем таблицу
	Возврат ТабРасход;
	
КонецФункции

//расчет одной строки АК
Процедура РасчетСтрокиАК(Военнослужащий, РасчетнаяДата, СтрАК) Экспорт
	
	//расчет года ограничения
	ГодОграничения=Год(РасчетнаяДата);
	Если НЕ СтрАК.Обеспеченность=0 Тогда
		СтрАК.ГодСводно=Формат(СтрАК.НачДата,"ДФ=MM-yyyy");
	КонецЕсли;
	
	//расчет выдачи
	СтрАК.Год2000="";
	СтрАК.Год2001="";
	СтрАК.Год2002="";
	СтрАК.Год2003="";
	СтрАК.Год2004="";
	СтрАК.Год2005="";
	СтрАК.Год2006="";
	СтрАК.Год2007="";
	СтрАК.Год2008="";
	СтрАК.Год2009="";
	СтрАК.Год2010="";
	СтрАК.Год2011="";
	СтрАК.Год2012="";
	СтрАК.Год2013="";
	СтрАК.Год2014="";
	СтрАК.Год2015="";
	
	ЗапросВыдачи=Новый Запрос;
	ЗапросВыдачи.Текст="ВЫБРАТЬ
	                   |	ВыдачаВещей.РабочийГод КАК РабочийГод,
	                   |	ВыдачаВещей.КолвоВыдачи,
	                   |	ВыдачаВещей.НомерДокумента,
	                   |	ВыдачаВещей.ДатаДокумента КАК ДатаДокумента,
	                   |	ВыдачаВещей.Замена
	                   |ИЗ
	                   |	РегистрСведений.ВыдачаВещей КАК ВыдачаВещей
	                   |ГДЕ
	                   |	ВыдачаВещей.Военнослужащий = &Военнослужащий
	                   |	И ВыдачаВещей.Вещь = &Вещь
	                   |
	                   |УПОРЯДОЧИТЬ ПО
	                   |	ДатаДокумента";
	ЗапросВыдачи.УстановитьПараметр("Военнослужащий",Военнослужащий);
	ЗапросВыдачи.УстановитьПараметр("Вещь",СтрАК.Вещь);
	ВыборкаВыдача=ЗапросВыдачи.Выполнить().Выбрать();
	
	КолвоВыдано=0;
	Пока ВыборкаВыдача.Следующий() Цикл
		ГодТекЧисло=Число(Лев(СокрЛП(ВыборкаВыдача.РабочийГод),4));
		Если ГодТекЧисло>ГодОграничения Тогда
			Продолжить;
		КонецЕсли;
		
		КолвоВыдано=КолвоВыдано+ВыборкаВыдача.КолвоВыдачи;
		СтрСводно=Формат(ВыборкаВыдача.ДатаДокумента,"ДФ=MM-yyyy");
		СтрОтображения=?(СокрЛП(ВыборкаВыдача.НомерДокумента)="","","док.№"+ОбрезатьНулиВНомереДок(СокрЛП(ВыборкаВыдача.НомерДокумента))+",")+
						Формат(ВыборкаВыдача.ДатаДокумента,"ДФ=MM")+"м="+
						СокрЛП(ВыборкаВыдача.КолвоВыдачи)+"шт"+
						?(ВыборкаВыдача.Замена=Истина,"(*)","")+"; ";
		
		Если ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2000 Тогда
			СтрАК.Год2000=СтрАК.Год2000+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2001 Тогда
			СтрАК.Год2001=СтрАК.Год2001+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2002 Тогда
			СтрАК.Год2002=СтрАК.Год2002+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2003 Тогда
			СтрАК.Год2003=СтрАК.Год2003+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2004 Тогда
			СтрАК.Год2004=СтрАК.Год2004+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2005 Тогда
			СтрАК.Год2005=СтрАК.Год2005+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2006 Тогда
			СтрАК.Год2006=СтрАК.Год2006+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2007 Тогда
			СтрАК.Год2007=СтрАК.Год2007+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2008 Тогда
			СтрАК.Год2008=СтрАК.Год2008+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2009 Тогда
			СтрАК.Год2009=СтрАК.Год2009+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2010 Тогда
			СтрАК.Год2010=СтрАК.Год2010+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2011 Тогда
			СтрАК.Год2011=СтрАК.Год2011+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2012 Тогда
			СтрАК.Год2012=СтрАК.Год2012+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2013 Тогда
			СтрАК.Год2013=СтрАК.Год2013+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2014 Тогда
			СтрАК.Год2014=СтрАК.Год2014+СтрОтображения;
		ИначеЕсли ВыборкаВыдача.РабочийГод=Перечисления.РабочиеГода.Год2015 Тогда
			СтрАК.Год2015=СтрАК.Год2015+СтрОтображения;
		КонецЕсли;
		СтрАК.ГодСводно=СокрЛП(СтрАК.ГодСводно)+?(СокрЛП(СтрАК.ГодСводно)="","",", ")+СтрСводно;
	КонецЦикла;
	СтрАК.КолвоВыдано=КолвоВыдано;
	
	//расчет положенности
	РазницаПолныхЛет=Год(РасчетнаяДата)-Год(СтрАК.НачДата)-1;
	Если РазницаПолныхЛет<0 Тогда
		ПрошлоМес=Месяц(РасчетнаяДата)-Месяц(СтрАК.НачДата)+1;
	Иначе
		ПрошлоМес=(РазницаПолныхЛет*12)+Месяц(РасчетнаяДата)+(13-Месяц(СтрАК.НачДата));
	КонецЕсли;
	ПрошлоМес=ПрошлоМес-СтрАК.ПриостановкаМес;
	
	ПоложеноВыдать=?(СтрАК.НормаСрок=0,0,Цел(ПрошлоМес/СтрАК.НормаСрок))*СтрАК.НормаКолво;
	ПоложеноВыдать=ПоложеноВыдать+СтрАК.НачКолво;
	ПоложеноВыдать=ПоложеноВыдать-СтрАК.КолвоВыдано;
	Если ПоложеноВыдать<0 Тогда
		ПоложеноВыдать=0;
	КонецЕсли;
	
	СтрАК.НормаТекст=СокрЛП(СтрАК.НормаКолво)+"шт Х "+СокрЛП(СтрАК.НормаСрок)+"мес";
	СтрАК.КонКолво=ПоложеноВыдать;
	
КонецПроцедуры

//расчитать арматурной карточки (главная функция)
Функция РасчетАрматурнойКарточки(Военнослужащий, РасчетнаяДата) Экспорт
	
	//расчет данных
	ЗапросАК=Новый Запрос;
	ЗапросАК.Текст=ПолучитьТекстЗапросаРасчетаАК();
	ЗапросАК.УстановитьПараметр("Военнослужащий",Военнослужащий);
	ЗапросАК.УстановитьПараметр("НормаВещевогоДовольствия",Военнослужащий.НормаВещевогоДовольствия);
	ЗапросАК.УстановитьПараметр("ДатаПриема",Военнослужащий.ДатаПриема);
	ТблАК=ЗапросАК.Выполнить().Выгрузить();
	
	//расчет приоставки сроков
	ПриостановкаМес=0;
	ЗапросПриостановки=Новый Запрос;
	ЗапросПриостановки.Текст="ВЫБРАТЬ
	                         |	ПриостановкаСроковВыдачи.ДатаНачала КАК ДатаНачала,
	                         |	ПриостановкаСроковВыдачи.ДатаКонца,
	                         |	ПриостановкаСроковВыдачи.Причина
	                         |ИЗ
	                         |	РегистрСведений.ПриостановкаСроковВыдачи КАК ПриостановкаСроковВыдачи
	                         |ГДЕ
	                         |	ПриостановкаСроковВыдачи.Военнослужащий = &Военнослужащий
	                         |
	                         |УПОРЯДОЧИТЬ ПО
	                         |	ДатаНачала";
	ЗапросПриостановки.УстановитьПараметр("Военнослужащий",Военнослужащий);
	ВыборкаПриостановки=ЗапросПриостановки.Выполнить().Выбрать();
	
	Пока ВыборкаПриостановки.Следующий() Цикл
		РазницаДат=(ВыборкаПриостановки.ДатаКонца-ВыборкаПриостановки.ДатаНачала)/86400;
		Если РазницаДат<0 Тогда
			РазницаДат=-1*РазницаДат;
		КонецЕсли;
		РазницаДат=РазницаДат+1;
		ПриостановкаМес=ПриостановкаМес+Окр(РазницаДат/30,0);
	КонецЦикла;
	
	Для Каждого СтрАК Из ТблАК Цикл
		СтрАК.ПриостановкаМес=ПриостановкаМес;
	КонецЦикла;
	
	//дополнительные колонки
	ТипСтрока80=Новый ОписаниеТипов("Строка",Новый КвалификаторыСтроки(80));
	ТблАК.Колонки.Добавить("Год2000",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2001",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2002",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2003",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2004",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2005",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2006",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2007",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2008",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2009",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2010",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2011",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2012",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2013",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2014",ТипСтрока80);
	ТблАК.Колонки.Добавить("Год2015",ТипСтрока80);
	
	ТипСтрока16=Новый ОписаниеТипов("Строка",Новый КвалификаторыСтроки(16));
	ТблАК.Колонки.Добавить("НормаТекст",ТипСтрока16);
	
	ТипСтрока120=Новый ОписаниеТипов("Строка",Новый КвалификаторыСтроки(120));
	ТблАК.Колонки.Добавить("ГодСводно",ТипСтрока120);
		
	//расчет строк
	Для Каждого СтрАК Из ТблАК Цикл
		РасчетСтрокиАК(Военнослужащий, РасчетнаяДата, СтрАК);
	КонецЦикла;
	
	//возврат
	Возврат ТблАК;
	
КонецФункции

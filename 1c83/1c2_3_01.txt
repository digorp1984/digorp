//загрузка оборотов МЗ   
Процедура ЗагрузитьОборотыМЗ() Экспорт
	
	//общие реквизиты
	ОчиститьСообщения();
	ТблОборотыМЗ=Новый ТаблицаЗначений;
	ТблОборотыМЗ.Колонки.Добавить("Период");
	ТблОборотыМЗ.Колонки.Добавить("НомерДок");
	ТблОборотыМЗ.Колонки.Добавить("ВидОперации");
	ТблОборотыМЗ.Колонки.Добавить("КФО");
	ТблОборотыМЗ.Колонки.Добавить("КБК");
	ТблОборотыМЗ.Колонки.Добавить("СчетДтТекст");
	ТблОборотыМЗ.Колонки.Добавить("СчетДт");
	ТблОборотыМЗ.Колонки.Добавить("СчетКтТекст");
	ТблОборотыМЗ.Колонки.Добавить("СчетКт");
	ТблОборотыМЗ.Колонки.Добавить("Сумма");
	ТблОборотыМЗ.Колонки.Добавить("Колво");
	ТблОборотыМЗ.Колонки.Добавить("НомеклатураНаименование");
	ТблОборотыМЗ.Колонки.Добавить("НомеклатураНомер");
	ТблОборотыМЗ.Колонки.Добавить("Номеклатура");
	ТблОборотыМЗ.Колонки.Добавить("МОЛНаименование");
	ТблОборотыМЗ.Колонки.Добавить("МОЛ");
	ТблОборотыМЗ.Колонки.Добавить("МОЛКт");
	ТблОборотыМЗ.Колонки.Добавить("КонтрагентИНН");
	ТблОборотыМЗ.Колонки.Добавить("КонтрагентНаименование");
	ТблОборотыМЗ.Колонки.Добавить("Контрагент");
	ТблОборотыМЗ.Колонки.Добавить("Договор");
	ТблОборотыМЗ.Колонки.Добавить("ГруппаНом");
	
	//чтение данных по МЗ
	Сообщить("1 из 3. Чтение файла оборотов МЗ ...");
	DBF = Новый XBase;
	Попытка
		DBF.ОткрытьФайл(СокрЛП(ФаилЗагрузки),,Истина);
	Исключение
		Сообщить("    ОШИБКА открытия файла " + СокрЛП(ФаилЗагрузки));
		Возврат;
	КонецПопытки;        
	Если НЕ DBF.Открыта() Тогда
		Сообщить("    ОШИБКА открытия файла " + СокрЛП(ФаилЗагрузки));
		Возврат;
	КонецЕсли;
	DBF.Кодировка = КодировкаXBase.OEM;
	DBF.ОтображатьУдаленные = Ложь;
	
	DBF.Первая();
	//........................................................................................................
	DBF.ЗакрытьФайл();
	
	//определение ссылок
	Сообщить("2 из 3. Опредление ссылок");
	ВыборкаКД=ПолучитьВыборкуКД();
	Для Каждого СтрТбл Из ТблОборотыМЗ Цикл
		Если ИспользоватьДетализированнуюНоменклатуру=Истина Тогда
			ГруппаНом=СокрЛП(СтрТбл.ГруппаНом);
			Если ГруппаНом="" Тогда
				Если Сред(СокрЛП(СтрТбл.СчетДтТекст),3,3)="105" Тогда
					ГруппаНом="Участок "+Сред(СокрЛП(СтрТбл.СчетДтТекст),3,6);
				Иначе
					ГруппаНом="Участок "+Сред(СокрЛП(СтрТбл.СчетКтТекст),3,6);
				КонецЕсли;
			КонецЕсли;
			СтрТбл.Номеклатура=ОпределитьНоменклатуру(СокрЛП(СтрТбл.НомеклатураНомер),СокрЛП(СтрТбл.НомеклатураНаименование),
				"","",ГруппаНом,СокрЛП(СтрТбл.МОЛНаименование));
		Иначе
			СтрТбл.Номеклатура=ОпределитьНоменклатуру(СокрЛП(СтрТбл.НомеклатураНомер),СокрЛП(СтрТбл.НомеклатураНаименование),
				"","",ГруппаНом,"");
		КонецЕсли;
		СтрТбл.МОЛ=ОпределитьМОЛ(,СокрЛП(СтрТбл.МОЛНаименование));
		
		Если (Сред(СокрЛП(СтрТбл.СчетКтТекст),3,3)="302") ИЛИ (Сред(СокрЛП(СтрТбл.СчетКтТекст),3,3)="401") ИЛИ
			(Сред(СокрЛП(СтрТбл.СчетКтТекст),3,3)="304") Тогда
			//покупка МЗ, внутриведомственное поступление (перемещение)
			КонтрагентСсылка=Справочники.Контрагенты.ПустаяСсылка();
			ДоговорСсылка=Справочники.Договоры.ПустаяСсылка();
			ОпределитьКонтрагентаПП(ВыборкаКД,КонтрагентСсылка,ДоговорСсылка,СокрЛП(СтрТбл.КонтрагентИНН),СокрЛП(СтрТбл.КонтрагентНаименование));
			СтрТбл.Контрагент=КонтрагентСсылка;
			СтрТбл.Договор=ДоговорСсылка;
		ИначеЕсли (Сред(СокрЛП(СтрТбл.СчетКтТекст),3,3)="105") И
			(Сред(СокрЛП(СтрТбл.СчетДтТекст),3,3)="105") Тогда
			//перемещение МЗ
			СтрТбл.МОЛКт=ОпределитьМОЛ(,СокрЛП(СтрТбл.КонтрагентНаименование));
			СтрТбл.Контрагент=Справочники.Контрагенты.ПустаяСсылка();
			СтрТбл.Договор=Справочники.Договоры.ПустаяСсылка();
		КонецЕсли;
	КонецЦикла;
	Если ТблОборотыМЗ.Количество()=0 Тогда
		Сообщить("В ДБФ нет данных для загрузки");
		Возврат;
	КонецЕсли;
	
	//формирование оборотов
	Если СоздаватьОперацииБух=Истина Тогда
		СоздатьБухОперации(ТблОборотыМЗ);
	Иначе
		Если СоздаватьОборотыДокументами=Истина Тогда
			СоздатьДокументыМЗ(ТблОборотыМЗ);
		Иначе
			СоздатьБухОперации(ТблОборотыМЗ);
			СоздатьДокументыМЗ(ТблОборотыМЗ);
		КонецЕсли;
	КонецЕсли;
	
	//завершение
	Сообщить("-------------------------------");
	Сообщить("Загрузка завершена!");
	
КонецПроцедуры

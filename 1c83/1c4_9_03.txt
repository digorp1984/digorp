//Расчет данных для выгрузки
Процедура ПолныйРасчетДанных()
	
	//1. ОБЩАЯ таблица
	ЗапросОС = Новый Запрос;	
	ЗапросОС.Текст="ВЫБРАТЬ
	               |	ЕПСБУОстаткиИОбороты.Счет,
	               |	ВЫБОР
	               |		КОГДА ЕПСБУОстаткиИОбороты.Счет = &Счет10127
	               |				И &ИсклБиблиотеку = ИСТИНА
	               |			ТОГДА ИСТИНА
	               |		КОГДА ЕПСБУОстаткиИОбороты.Счет = &Счет10137
	               |				И &ИсклБиблиотеку = ИСТИНА
	               |			ТОГДА ИСТИНА
	               |		КОГДА ЕПСБУОстаткиИОбороты.Счет = &Счет10147
	               |				И &ИсклБиблиотеку = ИСТИНА
	               |			ТОГДА ИСТИНА
	               |		ИНАЧЕ ЛОЖЬ
	               |	КОНЕЦ КАК СчетБибл,
	               |	ВЫБОР
	               |		КОГДА ЕПСБУОстаткиИОбороты.Счет В ИЕРАРХИИ (&Счет21)
	               |			ТОГДА ЕПСБУОстаткиИОбороты.Субконто1
	               |		ИНАЧЕ ЕПСБУОстаткиИОбороты.Субконто2
	               |	КОНЕЦ КАК ОС,
	               |	ВЫБОР
	               |		КОГДА ЕПСБУОстаткиИОбороты.Счет В ИЕРАРХИИ (&Счет21)
	               |			ТОГДА ЕПСБУОстаткиИОбороты.Субконто2
	               |		ИНАЧЕ ЕПСБУОстаткиИОбороты.Субконто3
	               |	КОНЕЦ КАК МОЛ,
	               |	ВЫБОР
	               |		КОГДА &ТипОстатков = ИСТИНА
	               |			ТОГДА ЕПСБУОстаткиИОбороты.КоличествоКонечныйОстаток
	               |		ИНАЧЕ ЕПСБУОстаткиИОбороты.КоличествоОборот
	               |	КОНЕЦ КАК Колво,
	               |	ВЫБОР
	               |		КОГДА &ТипОстатков = ИСТИНА
	               |			ТОГДА ЕПСБУОстаткиИОбороты.СуммаКонечныйОстаток
	               |		ИНАЧЕ ЕПСБУОстаткиИОбороты.СуммаОборот
	               |	КОНЕЦ КАК Сумма
	               |ПОМЕСТИТЬ ТблОстатки
	               |ИЗ
	               |	РегистрБухгалтерии.ЕПСБУ.ОстаткиИОбороты(&НачПериод, &КонПериод, , , Счет В ИЕРАРХИИ (&Счет), , Учреждение = &Учреждение) КАК ЕПСБУОстаткиИОбороты
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТблОстатки.Счет,
	               |	ТблОстатки.МОЛ,
	               |	ТблОстатки.ОС,
	               |	ТблОстатки.Колво,
	               |	ТблОстатки.Сумма,
	               |	ВЫБОР
	               |		КОГДА &ОтборПоМОЛ = ИСТИНА
	               |			ТОГДА ВЫБОР
	               |					КОГДА ТблОстатки.МОЛ = &МОЛ
	               |						ТОГДА ИСТИНА
	               |					ИНАЧЕ ЛОЖЬ
	               |				КОНЕЦ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ОтборМОЛ
	               |ПОМЕСТИТЬ ТблДопФильтр1
	               |ИЗ
	               |	ТблОстатки КАК ТблОстатки
	               |ГДЕ
	               |	ТблОстатки.СчетБибл = ЛОЖЬ
	               |	И ТблОстатки.Колво > 0
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТблДопФильтр1.Счет,
	               |	ТблДопФильтр1.ОС,
	               |	ТблДопФильтр1.МОЛ,
	               |	ТблДопФильтр1.Колво,
	               |	ТблДопФильтр1.Сумма
	               |ПОМЕСТИТЬ ТблДопФильтр2
	               |ИЗ
	               |	ТблДопФильтр1 КАК ТблДопФильтр1
	               |ГДЕ
	               |	ТблДопФильтр1.ОтборМОЛ = ИСТИНА
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СобытияОС.ОС,
	               |	МИНИМУМ(СобытияОС.ДатаСобытия) КАК ДатаВводаВЭксплуатацию
	               |ПОМЕСТИТЬ ТблВводЭэксплуатацию
	               |ИЗ
	               |	РегистрСведений.СобытияОС КАК СобытияОС
	               |ГДЕ
	               |	СобытияОС.ОС В
	               |			(ВЫБРАТЬ
	               |				ТблДопФильтр2.ОС
	               |			ИЗ
	               |				ТблДопФильтр2)
	               |	И СобытияОС.Событие = &СобытиеПринятиеКУчету
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СобытияОС.ОС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТблДопФильтр2.Счет КАК Счет,
	               |	ТблДопФильтр2.ОС КАК ОССсылка,
	               |	ТблДопФильтр2.МОЛ КАК МОЛСсылка,
	               |	ТблДопФильтр2.Колво КАК КолОст,
	               |	ТблДопФильтр2.Сумма,
	               |	ЕСТЬNULL(ТблВводЭэксплуатацию.ДатаВводаВЭксплуатацию, &НачПериод) КАК ДатаВводаВЭксплуатацию
	               |ИЗ
	               |	ТблДопФильтр2 КАК ТблДопФильтр2
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТблВводЭэксплуатацию КАК ТблВводЭэксплуатацию
	               |		ПО ТблДопФильтр2.ОС = ТблВводЭэксплуатацию.ОС
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Счет,
	               |	ОССсылка,
	               |	МОЛСсылка";
	ЗапросОС.УстановитьПараметр("ТипОстатков", Истина);
	ЗапросОС.УстановитьПараметр("НачПериод", КонецДня(ДатаОстатковОС));
	ЗапросОС.УстановитьПараметр("КонПериод", КонецДня(ДатаОстатковОС));
	ЗапросОС.УстановитьПараметр("Учреждение", Организация);
	ЗапросОС.УстановитьПараметр("Счет21", Счет21);//счет забаланса
	ЗапросОС.УстановитьПараметр("Счет", Счет);//счет отбора
	ЗапросОС.УстановитьПараметр("ИсклБиблиотеку", ИсклБиблиотеку);
	ЗапросОС.УстановитьПараметр("Счет10127", ПланыСчетов.ЕПСБУ.НайтиПоКоду("101.27"));
	ЗапросОС.УстановитьПараметр("Счет10137", ПланыСчетов.ЕПСБУ.НайтиПоКоду("101.37"));
	ЗапросОС.УстановитьПараметр("Счет10147", ПланыСчетов.ЕПСБУ.НайтиПоКоду("101.47"));
	ЗапросОС.УстановитьПараметр("ОтборПоМОЛ", ?(МОЛ.Пустая(),Ложь,Истина));
	ЗапросОС.УстановитьПараметр("МОЛ", МОЛ);
	ЗапросОС.УстановитьПараметр("СобытиеПринятиеКУчету", Перечисления.ВидыСобытийОС.ПринятиеКУчету);
	
	Попытка
		ТблОтбор=ЗапросОС.Выполнить().Выгрузить();
	Исключение
		ТблОтбор=Новый ТаблицаЗначений;
		Сообщить("При формировании выборки данных возникли ошибки!",СтатусСообщения.Важное);
		Сообщить("(ваша конфигурация не потдерживается обработкой)");
	КонецПопытки;
	
	//2. ДОПОЛНИТЕЛЬНЫЕ таблицы
	
	//Проверка подключения доработки - состав
	СоставПодключен=Истина;
	ЗапросКомплектация=Новый Запрос;
	ЗапросКомплектация.Текст="ВЫБРАТЬ
	                         |	КомплектующиеОС.ОС КАК ОС,
	                         |	КомплектующиеОС.Наименование КАК Наименование,
	                         |	КомплектующиеОС.СерийныйНомер,
	                         |	МИНИМУМ(КомплектующиеОС.Количество) КАК Количество,
	                         |	МИНИМУМ(КомплектующиеОС.Цена) КАК Цена,
	                         |	МИНИМУМ(КомплектующиеОС.Стоимость) КАК Стоимость,
	                         |	МИНИМУМ(КомплектующиеОС.Период) КАК Период
	                         |ИЗ
	                         |	РегистрСведений.КомплектующиеОС КАК КомплектующиеОС
	                         |ГДЕ
	                         |	КомплектующиеОС.Период <= &КонПериод
	                         |
	                         |СГРУППИРОВАТЬ ПО
	                         |	КомплектующиеОС.ОС,
	                         |	КомплектующиеОС.Наименование,
	                         |	КомплектующиеОС.СерийныйНомер
	                         |
	                         |УПОРЯДОЧИТЬ ПО
	                         |	ОС,
	                         |	Период,
	                         |	Наименование";
	ЗапросКомплектация.УстановитьПараметр("КонПериод",КонецДня(ДатаОстатковОС));
	
	Попытка
		ВыборкаКомплектация=ЗапросКомплектация.Выполнить().Выбрать();
		Если ВыборкаКомплектация.Количество()=0 Тогда
			СоставПодключен=Ложь;
		КонецЕсли;
	Исключение
		СоставПодключен=Ложь;
		ВыборкаКомплектация=Неопределено;
		Сообщить("Доработка по комплектации ОС не подключена!");
	КонецПопытки;
	
	//местонахождение - текущие
	ЗапросУточнениеИнвНом=Новый Запрос;
	ЗапросУточнениеИнвНом.Текст="ВЫБРАТЬ
	                            |	МестонахождениеОССрезПоследних.ОС КАК ОС,
	                            |	МестонахождениеОССрезПоследних.ЦМО КАК МОЛ,
	                            |	МестонахождениеОССрезПоследних.НомерСтроки КАК НомерСтроки,
	                            |	МестонахождениеОССрезПоследних.ИнвНомер КАК ИнвНомСсылка
	                            |ИЗ
	                            |	РегистрСведений.МестонахождениеОС.СрезПоследних(&КонПериод, ) КАК МестонахождениеОССрезПоследних
	                            |
	                            |УПОРЯДОЧИТЬ ПО
	                            |	ОС,
	                            |	МОЛ,
	                            |	НомерСтроки";
	ЗапросУточнениеИнвНом.УстановитьПараметр("КонПериод",КонецДня(ДатаОстатковОС));
	ВыбУточнениеИнвНом=ЗапросУточнениеИнвНом.Выполнить().Выбрать();
	
	//расчетная таблица
	ТипЧисло4=Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(4));
	ТблОССчет=Новый ТаблицаЗначений;
	ТблОССчет.Колонки.Добавить("ОС");
	ТблОССчет.Колонки.Добавить("КолвоПовторов",ТипЧисло4);
	
	Если ОССчетЗабаланса=Истина Тогда
		//установим отсуп в нумерации по сравнению с балансовыми ОС
		ЗапросОстаткиДоп = Новый Запрос;	
		ЗапросОстаткиДоп.Текст="ВЫБРАТЬ
		                       |	ЕПСБУОстатки.Субконто2 КАК ОС,
		                       |	ЕПСБУОстатки.КоличествоОстаток
		                       |ИЗ
		                       |	РегистрБухгалтерии.ЕПСБУ.Остатки(&КонПериод, Счет В ИЕРАРХИИ (&СчетБаланса), , Учреждение = &Учреждение) КАК ЕПСБУОстатки";
		ЗапросОстаткиДоп.УстановитьПараметр("КонПериод", КонецДня(ДатаОстатковОС));
		ЗапросОстаткиДоп.УстановитьПараметр("Учреждение", Организация);
		ЗапросОстаткиДоп.УстановитьПараметр("СчетБаланса", ПланыСчетов.ЕПСБУ.НайтиПоКоду("101.00"));
		ВыборкаОстаткиДоп=ЗапросОстаткиДоп.Выполнить().Выбрать();
		Пока ВыборкаОстаткиДоп.Следующий() Цикл
			НовСтр=ТблОССчет.Добавить();
			НовСтр.ОС=ВыборкаОстаткиДоп.ОС;
			НовСтр.КолвоПовторов=ВыборкаОстаткиДоп.КоличествоОстаток;
		КонецЦикла;
	КонецЕсли;
	
	
КонецПроцедуры

//поиск или создание (контрагента + договор + счет)
Процедура ОпределитьКонтрагентаРасширенныйРежим(ВыборкаКД,КонтрагентСсылка,ДоговорСсылка,СчетКонтрагента,СтрСчет1,ВидПоиска=1)
	
	//определяем контрагента и счет
	ДоговорОбщий=Справочники.Договоры.ПустаяСсылка();
	ОпределитьКонтрагентаПП(ВыборкаКД,КонтрагентСсылка,ДоговорОбщий,СчетКонтрагента,
		СокрЛП(СтрСчет1.КонтрагентИНН),СокрЛП(СтрСчет1.КонтрагентНаим));
		
	//определяем договор
	Если ВидПоиска=1 Тогда
		//проверка
		Если СокрЛП(СтрСчет1.ДоговорНомер)="" Тогда
			ДоговорСсылка=ДоговорОбщий;
			Возврат;
		КонецЕсли;
		
		//поиск номеру и дате договора
		ЗапросПоиск=Новый Запрос;
		ЗапросПоиск.Текст="ВЫБРАТЬ
		                  |	Договоры.Ссылка КАК Ссылка
		                  |ИЗ
		                  |	Справочник.Договоры КАК Договоры
		                  |ГДЕ
		                  |	Договоры.ПометкаУдаления = ЛОЖЬ
		                  |	И Договоры.ДатаДоговора = &ДатаДоговора
		                  |	И Договоры.НомерДоговора = &НомерДоговора";
		ЗапросПоиск.УстановитьПараметр("ДатаДоговора",СтрСчет1.ДоговорДата);
		ЗапросПоиск.УстановитьПараметр("НомерДоговора",СокрЛП(СтрСчет1.ДоговорНомер));
		ВыборкаПоиск=ЗапросПоиск.Выполнить().Выбрать();
		Пока ВыборкаПоиск.Следующий() Цикл
			ДоговорСсылка=ВыборкаПоиск.Ссылка;
		КонецЦикла;
		
	ИначеЕсли ВидПоиска=2 Тогда
		//поиск номеру и дате счета
		ЗапросПоиск=Новый Запрос;
		ЗапросПоиск.Текст="ВЫБРАТЬ
		                  |	Счет.Договор
		                  |ИЗ
		                  |	Документ.Счет КАК Счет
		                  |ГДЕ
		                  |	Счет.Номер = &СчетНомер
		                  |	И Счет.Дата = &СчетДата";
		ЗапросПоиск.УстановитьПараметр("СчетНомер",СокрЛП(СтрСчет1.СчетНомер));
		ЗапросПоиск.УстановитьПараметр("СчетДата",СокрЛП(СтрСчет1.СчетДата));
		ВыборкаПоиск=ЗапросПоиск.Выполнить().Выбрать();
		Пока ВыборкаПоиск.Следующий() Цикл
			ДоговорСсылка=ВыборкаПоиск.Договор;
		КонецЦикла;
		
		//проверка
		Если ДоговорСсылка=Справочники.Договоры.ПустаяСсылка() Тогда
			ДоговорСсылка=ДоговорОбщий;
			Возврат;
		КонецЕсли;
		
	ИначеЕсли ВидПоиска=3 Тогда
		//поиск по наименованию договора
		ЗапросПоиск=Новый Запрос;
		ЗапросПоиск.Текст="ВЫБРАТЬ
		                  |	Договоры.Ссылка КАК Ссылка
		                  |ИЗ
		                  |	Справочник.Договоры КАК Договоры
		                  |ГДЕ
		                  |	Договоры.ПометкаУдаления = ЛОЖЬ
		                  |	И Договоры.Наименование = &ДоговорТекст";
		ЗапросПоиск.УстановитьПараметр("ДоговорТекст",СокрЛП(СтрСчет1.ДоговорТекст));
		ВыборкаПоиск=ЗапросПоиск.Выполнить().Выбрать();
		Пока ВыборкаПоиск.Следующий() Цикл
			ДоговорСсылка=ВыборкаПоиск.Ссылка;
		КонецЦикла;
	КонецЕсли;
	
	//создание договора
	Если (ДоговорСсылка=Справочники.Договоры.ПустаяСсылка()) И 
		(НЕ КонтрагентСсылка=Справочники.Контрагенты.ПустаяСсылка()) Тогда
		НовДог=Справочники.Договоры.СоздатьЭлемент();
		НовДог.Учреждение=Учреждение;
		НовДог.Контрагент=КонтрагентСсылка;
		Если ВидПоиска=3 Тогда
			НовДогНаименование=СокрЛП(СтрСчет1.ДоговорТекст);
			НовДог.Наименование=НовДогНаименование;
		Иначе
			НовДогНаименование="Договор №"+СокрЛП(СтрСчет1.ДоговорНомер)+" от "+Формат(СтрСчет1.ДоговорДата,"ДФ=dd.MM.yyyy");
			НовДог.Наименование=НовДогНаименование;
			НовДог.ДатаДоговора=СтрСчет1.ДоговорДата;
			НовДог.НомерДоговора=СокрЛП(СтрСчет1.ДоговорНомер);
		КонецЕсли;
		НовДог.СчетКонтрагента=СчетКонтрагента;
		НовДог.УчреждениеИсполнитель=Ложь;
		НовДог.ВидОбязательства="Договор";
		НовДог.ТипДоговораНДС=Перечисления.НДС_ТипыДоговоров.Обычный;
		НовДог.Записать();
		
		Сообщить("     Создан договор: "+НовДогНаименование);
		ДоговорСсылка=НовДог.Ссылка;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьСсылкиКД() Экспорт
	
	//параметры
	ТблКД=Новый ТаблицаЗначений;
	ТблКД.Колонки.Добавить("КонтрагентНаим");
	ТблКД.Колонки.Добавить("КонтрагентИНН");
	ТблКД.Колонки.Добавить("Контрагент");
	ТблКД.Колонки.Добавить("Договор");
	ТблКД.Колонки.Добавить("Повторы");
	
	//чтение данных
	Сообщить("1 из 2. Чтение файла данных ...");
	DBF = Новый XBase;
	Попытка
		DBF.ОткрытьФайл(СокрЛП(ФаилЗагрузки),,Истина);
	Исключение
		Сообщить("    ОШИБКА открытия файла " + СокрЛП(ФаилЗагрузки));
		Возврат;
	КонецПопытки;        
	Если НЕ DBF.Открыта() Тогда
		Сообщить("    ОШИБКА открытия файла " + СокрЛП(ФаилЗагрузки));
		Возврат;
	КонецЕсли;
	DBF.Кодировка = КодировкаXBase.OEM;
	DBF.ОтображатьУдаленные = Ложь;
	
	DBF.Первая();
	Пока НЕ DBF.ВКонце() Цикл
		//общие
		Если (Сред(СокрЛП(DBF.SCHETKT),3,3)="302") ИЛИ (Сред(СокрЛП(DBF.SCHETKT),3,3)="304") Тогда 
			Если (НЕ СокрЛП(DBF.KONTR_NAIM)="") ИЛИ (НЕ СокрЛП(DBF.KONTR_INN)="") Тогда 
				НовСтрКД=ТблКД.Добавить();
				НовСтрКД.КонтрагентНаим=СокрЛП(DBF.KONTR_NAIM);
				НовСтрКД.КонтрагентИНН=СокрЛП(DBF.KONTR_INN);
				НовСтрКД.Договор=Справочники.Договоры.ПустаяСсылка();
				НовСтрКД.Договор=Справочники.Контрагенты.ПустаяСсылка();
				НовСтрКД.Повторы=1;
			КонецЕсли;
		КонецЕсли;
				
		//шагаем дальше
		DBF.Следующая()
	КонецЦикла;
	ТблКД.Свернуть("КонтрагентНаим,КонтрагентИНН,Контрагент,Договор","Повторы");
	
	//опредление ссылок
	Сообщить("2 из 2. Определение ссылок");
	ВыборкаКД=ПолучитьВыборкуКД();
	Для Каждого СтрДок Из ТблКД Цикл
		КонтрагентСсылка=Справочники.Контрагенты.ПустаяСсылка();
		ДоговорСсылка=Справочники.Договоры.ПустаяСсылка();
		ОпределитьКонтрагентаПП(ВыборкаКД,КонтрагентСсылка,ДоговорСсылка,СокрЛП(СтрДок.КонтрагентИНН),СокрЛП(СтрДок.КонтрагентНаим));
		СтрДок.Контрагент=КонтрагентСсылка;
		СтрДок.Договор=ДоговорСсылка;
	КонецЦикла;
	
	//завершение
	Сообщить("-------------------------------");
	Сообщить("Анализ завершена!");
	
КонецПроцедуры

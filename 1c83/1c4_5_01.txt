&НаКлиенте
Процедура СформироватьВедомостьВExcel(Команда)
	
	//параметры
	ОчиститьСообщения();
	ДвоичныеДанныеМакета = ПолучтьДвоичныеДанныеМакета();
	
	//расчет данных
	ТекстСообщения = НСтр("ru = '1 из 3. Выполняется расчет данных...'");
	Состояние(ТекстСообщения);
	
	СтруктураПараметров=ПоулчитьСтруктураПараметровДляВыгрузки();
	Если СтруктураПараметров.Количество()=0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет данных для выгрузки в отчет.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	//инициализация excel
	ТекстСообщения = НСтр("ru = '2 из 3. Инициализация Excel'");
	Состояние(ТекстСообщения);
	
#Если ВебКлиент Тогда
	ИмяВременногоФайла = Строка(Новый УникальныйИдентификатор) + ".xls";
	ОписанияФайлов = Новый Массив;
	ОписанияФайлов.Добавить(Новый ОписаниеПередаваемогоФайла(ИмяВременногоФайла, ПоместитьВоВременноеХранилище(ДвоичныеДанныеМакета)));
	Если НЕ ПолучитьФайлы(ОписанияФайлов, , КаталогВременныхФайлов(), Ложь) Тогда
		ТекстСообщения = НСтр("ru = 'ОШИБКА: Не удалось создать временный фаил.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;
	ИмяВременногоФайла = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(КаталогВременныхФайлов()) + ИмяВременногоФайла;
#Иначе
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла("xls");
	ДвоичныеДанныеМакета.Записать(ИмяВременногоФайла);
#КонецЕсли
	
	Попытка
		Excel = Новый COMОбъект("Excel.Application");
		Excel.Visible = True;
	Исключение
		ТекстСообщения = НСтр("ru = 'ОШИБКА: Не удалось подключить COMОбъект.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецПопытки;
	
	Попытка
		Workbook = Excel.Workbooks.Open(ИмяВременногоФайла);
	Исключение
		Excel.Quit();
		Excel = Неопределено;
		ТекстСообщения = НСтр("ru = 'ОШИБКА: Ошибка при открытии файла шаблона.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецПопытки;
	
	//заполнеие excel
	ТекстСообщения = НСтр("ru = '3 из 3. Заполнение данных...'");
	Состояние(ТекстСообщения);
	
	МассивОбластей = ПолучитьМассивОбластей();
	ИндексНачала = 0;
	ИндексКонца = 0;
	ИндексМин = 0;
	
	Для Каждого Область Из МассивОбластей Цикл
		
		Если Область[4]=0 Тогда
			//обычная область
			Попытка
				//может не быть листа, области, параметра 1С
				Лист = Workbook.Sheets(Область[3]);
				Ячейка = Лист.Cells(Область[1], Область[2]);
				Ячейка.Value = СтруктураПараметров[Область[0]];
			Исключение
			КонецПопытки;
			
		Иначе
			
			//колонки в цикле
			МассивДанных=СтруктураПараметров["МассивДанных"];
			ИндексНачала=Область[5];
			ИндексКонца=Область[6];
			
			ИндексМин=Мин((МассивДанных.Количество()-1+ИндексНачала), ИндексКонца);
			
			Для НП=ИндексНачала По ИндексМин Цикл
				Лист = Workbook.Sheets(Область[3]);
				СтрокаДанных=МассивДанных[НП-ИндексНачала];
				Ячейка = Лист.Cells(Область[1], НП);
				Ячейка.Value = СтрокаДанных[Число(Область[0])];
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	//удаление лишних колонок
	Если (ИндексМин+1)<=ИндексКонца Тогда
		//удаление колонок
		КолонкаНачало=Из_10_В_Любую(ИндексМин);
		КолонкаКонец=Из_10_В_Любую(ИндексКонца-1);
		УдаляемыеКолонкиТекст=КолонкаНачало+":"+КолонкаКонец;
		Лист.Columns(УдаляемыеКолонкиТекст).Delete(-4159);
	КонецЕсли;
	
	//завершение
	Workbook.Save();
	Workbook = Неопределено;
	Excel = Неопределено;
	
КонецПроцедуры
